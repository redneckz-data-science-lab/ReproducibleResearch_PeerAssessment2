---
title: 'Reproducible Research: Peer Assessment 2'
output:
  html_document:
    keep_md: yes
  pdf_document: default
---

# Tornadoes and flooding are the most harmful events in the US

# Synopsis

The [Storm Data](http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2) [47Mb] from the NOAA has been used to answer following questions:

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?

First of all the data has been cleaned. Values of the *event type* variable have been *adjusted*.
Then data has been *aggregated* by health related variables (fatalities, injuries) and economics related variables (property damage, crop damage).
Then *sorted* and *truncated*.
At the end the appropriate plots have been constructed to show the impact on health and economics respectively (in the form of a rating).

# Data Processing

## Loading the storm data

```{r}
# Trying to load dependencies
library(data.table)
library(ggplot2)
library(stringi)
library(reshape2)
```

```{r, cache = TRUE}
temp.f <- tempfile(fileext=".csv.bz2")
download.file("http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", destfile = temp.f)
storm.data <- data.table(read.csv(temp.f))
unlink(temp.f)
```

## First look at the loaded data

```{r}
str(storm.data)
```

So the variables of interest are:

1. *EVTYPE* - Event type (text).

2. *FATALITIES* - Death count. Relates to the population health question.

3. *INJURIES* - Injuries count. Relates to the population health question.

4. *PROPDMG* - Property damage estimation (in U.S. dollars). Relates to the economic consequences question.

5. *CROPDMG* - Crop damage estimation (in U.S. dollars). Relates to the economic consequences question.

Are there any empty values?

```{r}
ifelse(any(is.na(storm.data$EVTYPE),
           is.na(storm.data$FATALITIES),
           is.na(storm.data$INJURIES),
           is.na(storm.data$PROPDMG),
           is.na(storm.data$CROPDMG)), "YES", "NO")
```

How many different types of events exist?

```{r}
original.event.type.count <- length(levels(factor(storm.data$EVTYPE)))
print(original.event.type.count)
```

Seem to be event type variable is not clean enough to be used as classifier. There are a lot of typos, semantic duplicates, and mixed values.

## Cleaning event type variable

```{r}
invisible({
    storm.data[, EVTYPE := stri_trim_both(EVTYPE)]
    storm.data[, EVTYPE := stri_trans_toupper(EVTYPE)]
    # Removing trailing separator symbols
    storm.data[, EVTYPE := stri_replace_all_regex(EVTYPE, "[/\\-\\.;]+$", "")]
    # Replacing different variants of separators by / symbol
    storm.data[, EVTYPE := stri_replace_all_regex(EVTYPE, "\\s*(/|\\\\|&|;)\\s*", "/")]
    storm.data[, EVTYPE := stri_replace_all_regex(EVTYPE, "\\s+AND\\s+", "/")]
    # Moving unnecessary event types to OTHER category
    storm.data[, EVTYPE := stri_replace_all_regex(EVTYPE, ".*(SUMMARY).*", "OTHER")]
    # Replacing sequences of white space symbols by only one space symbol
    storm.data[, EVTYPE := stri_replace_all_regex(EVTYPE, "\\s+", " ")]
    # Removing some semantic duplicates or very close categories
    storm.data[, EVTYPE := stri_replace_all_fixed(EVTYPE, "?", "NONE")]
    storm.data[, EVTYPE := stri_replace_all_regex(EVTYPE, "(WINTRY|WINTERY)", "WINTER")]
    storm.data[, EVTYPE := stri_replace_all_regex(EVTYPE, "^TSTM\\s+", "THUNDERSTORM ")]
    storm.data[, EVTYPE := stri_replace_all_fixed(EVTYPE, "FLASH FLOOD", "FLOOD")]
    storm.data[, EVTYPE := stri_replace_all_fixed(EVTYPE, "EXCESSIVE HEAT", "HEAT")]
    storm.data[, EVTYPE := stri_replace_all_fixed(EVTYPE, "THUNDERSTORM WINDS", "THUNDERSTORM WIND")]
})
```

How many event types was rejected during cleaning stage?

```{r}
original.event.type.count - length(levels(factor(storm.data$EVTYPE)))
```

Computing the *total number of deaths* per event type:

```{r}
fatalities.by.type <- storm.data[, sum(FATALITIES), by = EVTYPE]
invisible({
    fatalities.by.type[, FATALITIES := V1]
    fatalities.by.type[, V1 := NULL]
})

```

Computing the *total number of injuries* per event type:

```{r}
injuries.by.type <- storm.data[, sum(INJURIES), by = EVTYPE]
invisible({
    injuries.by.type[, INJURIES := V1]
    injuries.by.type[, V1 := NULL]
})
```

Merging *health impacts* and picking up most significant of them:

```{r}
health.impacts.by.type <- merge(fatalities.by.type, 
                                injuries.by.type,
                                by = "EVTYPE")
# Order by fatalities
health.impacts.by.type.top <- head(health.impacts.by.type[order(-FATALITIES)])
invisible({
    # Converting EVTYPE to factor with respect to ordering
    health.impacts.by.type.top[, EVTYPE := factor(EVTYPE, levels = EVTYPE)]
})
```

Computing the *total property damage* per event type:

```{r}
property.damage.by.type <- storm.data[, sum(PROPDMG), by = EVTYPE]
invisible({
    property.damage.by.type[, PROPDMG := V1]
    property.damage.by.type[, V1 := NULL]
})
```

Computing the *total crop damage* per event type:

```{r}
crop.damage.by.type <- storm.data[, sum(CROPDMG), by = EVTYPE]
invisible({
    crop.damage.by.type[, CROPDMG := V1]
    crop.damage.by.type[, V1 := NULL]
})
```

Merging *economic impacts* and picking up most significant of them:

```{r}
economic.impacts.by.type <- merge(property.damage.by.type,
                                  crop.damage.by.type,
                                  by = "EVTYPE")
# Order by total damage
economic.impacts.by.type.top <- head(economic.impacts.by.type[order(-(PROPDMG + CROPDMG))])
invisible({
    # Converting EVTYPE to factor with respect to ordering
    economic.impacts.by.type.top[, EVTYPE := factor(EVTYPE, levels = EVTYPE)]
})
```

# Results

```{r}
ggplot(health.impacts.by.type.top, aes(EVTYPE, FATALITIES, fill = EVTYPE)) +
    geom_bar(position = "dodge", stat = "identity") +
    labs(title = "Fatalities by Event Type", x = "", y = "") +
    theme(axis.text.x = element_text(angle = 20))
```

```{r}
ggplot(health.impacts.by.type.top, aes(EVTYPE, INJURIES, fill = EVTYPE)) +
    geom_bar(position = "dodge", stat = "identity") +
    labs(title = "Injuries by Event Type", x = "", y = "") +
    theme(axis.text.x = element_text(angle = 20))
```

Thus *tornadoes* and *flooding* are the most awful events with respect to *population health*. In the second place there is the *heat* category. And this is strange thing. I have no explanation for such case.

```{r}
economic.impacts.melted <- melt(economic.impacts.by.type.top, id.vars = "EVTYPE")
ggplot(economic.impacts.melted, aes(EVTYPE, value, fill=EVTYPE, colour=variable)) +
    geom_bar(stat = "identity") +
    labs(title = "Economic Impacts by Event Type", x = "",
         y = "Damage in U.S dollars") +
    theme(axis.text.x = element_text(angle = 20))
```

And once aganin *tornadoes* and *flooding* are the most harmful with respect to *economics*. In the second place *thunderstorm wind*. Other categories have significantly lower rates.
